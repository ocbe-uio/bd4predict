<!DOCTYPE html>
<html>
<head>
	<title>BD4QoL :: Clinical Prediction Model Dashboard</title>
    <link rel="stylesheet" href="style.css">
	<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
	<script>
		
		function toggleC30(value) {
			var details = document.getElementById("c30_details");
			if (value === "yes") {
				details.style.display = "block";
			} else {
				details.style.display = "none";
			}
		}
		
		function toggleHn35(value) {
			var details = document.getElementById("hn35_details");
			if (value === "yes") {
				details.style.display = "block";
			} else {
				details.style.display = "none";
			}
		}
		</script>



</head>

	
<body>

		<!-- bd4qol color #902827 -->
		<h1><img src="bd4qol-logo.jpeg" alt="BD4QoL Logo" style="width: 275.5px; height: 110px;"></h1>
	

    <h2>Clinical Prediction Model Dashboard</h2>
	<h2>Endpoint: EORTC QLQ-C30 GHS/QoL</h2>
	<div class="flex-container">
		<!-- Main form fields container -->
	
		<div class="form-container form-style">
			<form id="myForm" onsubmit="submitForm(event);">
				<label for="hn1_dv_age_cons">Age:</label>
				<input type="number" id="hn1_dv_age_cons" name="hn1_dv_age_cons" min="18" max="92" required><br><br>
				
				<label for="hn1_na8_cb_sex">Sex:</label>
				<select id="hn1_na8_cb_sex" name="hn1_na8_cb_sex" required>
					<option value="" disabled selected>Select sex</option>
					<option value="0">Male</option>
					<option value="1">Female</option>
				</select><br><br>
	
				<label for="hn1_icd_group_conf">Tumour Region:</label>
				<select id="hn1_icd_group_conf" name="hn1_icd_group_conf" required>
					<option value="" disabled selected>Select tumour region</option>
					<option value="1 - oral cavity">Oral cavity</option>
					<option value="2 - oropharynx">Oropharynx</option>
					<option value="3 - nasopharynx">Nasopharynx</option>
					<option value="4 - hypopharynx">Hypopharynx</option>
					<option value="5 - larynx">Larynx</option>
					<option value="6 - nasal cavity/sinuses">Nasal cavity/Sinuses</option>
				</select><br><br>
	
				<label for="hn1_tnm_stage_best">Tumor Staging:</label>
				<select id="hn1_tnm_stage_best" name="hn1_tnm_stage_best" required>
					<option value="" disabled selected>Select tumor staging</option>
					<option value="1">I</option>
					<option value="2">II</option>
					<option value="3">III</option>
					<option value="4">IV</option>
				</select><br><br>
	
				<label for="hn1_a7a_ay_education_level">Education Level:</label>
				<select id="hn1_a7a_ay_education_level" name="hn1_a7a_ay_education_level" required>
					<option value="" disabled selected>Select education level</option>
					<option value="1">Maximum 6 years </option>
					<option value="2">Between 7 and 11 years </option>
					<option value="3">12 to 13 years</option>
					<option value="4">More than 13 years</option>
					<option value="-1">Missing</option>
				</select><br><br>

			
					<label for="hn1_a5_ay_marital_status">Marital Status:</label>
					<select id="hn1_a5_ay_marital_status" name="hn1_a5_ay_marital_status" required>
						<option value="" disabled selected>Select marital status</option>
						<option value="1 - single">1 - Single</option>
						<option value="2 - widowed">2 - Widowed</option>
						<option value="3 - separated">3 - Separated</option>
						<option value="4 - married">4 - Married</option>
						<option value="5 - divorced">5 - Divorced</option>
						<option value="6 - living with a partner">6 - Living with a partner</option>
						<option value="missing">Missing</option>
					</select><br><br>
			
				
				<label for="hn1_imd10quint">Regional deprivation index:</label>
				<select id="hn1_imd10quint" name="hn1_imd10quint" required>
					<option value="" disabled selected>Select level</option>
					<option value="0">Least deprived</option>
					<option value="1">Less</option>
					<option value="2">Middle</option>
					<option value="3">More</option>
					<option value="4">Most deprived</option>
					<option value="-1">Missing</option>
				</select><br><br>

				<label for="hn1_dv_a21_ay_hhold_income">Household income:</label>
				<select id="hn1_dv_a21_ay_hhold_income" name="hn1_dv_a21_ay_hhold_income" required>
					<option value="" disabled selected>Select level</option>
					<option value="1">Less than &pound3999 </option>
					<option value="2">&pound4000-&pound7999 </option>
					<option value="3">&pound8000-&pound11999 </option>
					<option value="4">&pound12000-&pound17999 </option>
					<option value="5">&pound18000-&pound22999 </option>
					<option value="6">&pound23000-&pound28999 </option>
					<option value="7">&pound29000-34999 </option>
					<option value="8"> &pound35000 or more</option>
					<option value="-1">Missing</option>
				</select><br><br>	
	
				<label for="hn1_nb4_cb_comorb_index">Comorbidity:</label>
				<select id="hn1_nb4_cb_comorb_index" name="hn1_nb4_cb_comorb_index" required>
					<option value="" disabled selected>Select comorbidity level</option>
					<option value="1">No comorbidity</option>
					<option value="2">Mild</option>
					<option value="3">Moderate</option>
					<option value="4">Severe</option>
					<option value="-1">Missing</option>
				</select><br><br>
	
				<label for="hn1_dv_bmi">BMI:</label>
				<input type="number" id="hn1_dv_bmi" name="hn1_dv_bmi"><br><br>
	
				<label for="hn1_nb9a_cb_hpv_status">HPV Status:</label>
				<select id="hn1_nb9a_cb_hpv_status" name="hn1_nb9a_cb_hpv_status" required>
					<option value="" disabled selected>Select HPV status</option>
					<option value="not obtained">Not obtained</option>
					<option value="positive">Positive</option>
					<option value="negative">Negative</option>
				</select><br><br>
	
				<label for="hn1_surgery">Surgery:</label>
				<select id="hn1_surgery" name="hn1_surgery" required>
					<option value="" disabled selected>Select surgery status</option>
					<option value="1">Yes</option>
					<option value="0">No</option>
				</select><br><br>
	
				<label for="hn1_chemotherapy">Chemotherapy:</label>
				<select id="hn1_chemotherapy" name="hn1_chemotherapy" required>
					<option value="" disabled selected>Select chemotherapy status</option>
					<option value="1">Yes</option>
					<option value="0">No</option>
				</select><br><br>
	
				<label for="hn1_radiotherapy">Radiotherapy:</label>
				<select id="hn1_radiotherapy" name="hn1_radiotherapy" required>
					<option value="" disabled selected>Select radiotherapy status</option>
					<option value="1">Yes</option>
					<option value="0">No</option>
				</select><br><br>
	
				<label for="hn1_a8_ay_tobacco">Smoking Status:</label>
				<select id="hn1_a8_ay_tobacco" name="hn1_a8_ay_tobacco" required>
					<option value="" disabled selected>Select smoking status</option>
					<option value="3 - never">Never smoked</option>
					<option value="2 - former">Former smoker</option>
					<option value="1 - current user">Current smoker</option>
					<option value="missing">Missing</option>
				</select><br><br>
	
				<label for="hn1_dv_total_wk">Alcohol Consumption:</label>
				<input type="number" id="hn1_dv_total_wk" name="hn1_dv_total_wk"><br><br>
			
	

			<label for="eortc_qlq_c30">Answered the EORTC QLQ-C30 Questionnaire?</label>
			<select id="eortc_qlq_c30" name="eortc_qlq_c30" required onchange="toggleC30(this.value)">
				<option value="" disabled selected>Select answer</option>
				<option value="yes">Yes</option>
				<option value="no">No</option>
			</select>


			<label for="eortc_qlq_hn35">Answered the EORTC QLQ-H&N35 Questionnaire?</label>
			<select id="eortc_qlq_hn35" name="eortc_qlq_hn35" required onchange="toggleHn35(this.value)">
				<option value="" disabled selected>Select answer</option>
				<option value="yes">Yes</option>
				<option value="no">No</option>
			</select>
		</div>

		<div id="c30_details"  class="details-container form-style" style="display: none;">
				<p>Please enter your EORTC QLQ-C30 responses (values between 0 and 100, use -1 for missing):</p>
				
				<label for="role_func">Role Functioning:</label>
				<input type="number" id="role_func" name="hn3_dv_c30_role_func" min="-1" max="100" value="-1" required><br><br>
			
				<label for="phys_func">Physical Functioning:</label>
				<input type="number" id="phys_func" name="hn3_dv_c30_phys_func" min="-1" max="100" value="-1" required><br><br>
			
				<label for="emot_func">Emotional Functioning:</label>
				<input type="number" id="emot_func" name="hn3_dv_c30_emot_func" min="-1" max="100" value="-1" required><br><br>
			
				<label for="cog_func">Cognitive Functioning:</label>
				<input type="number" id="cog_func" name="hn3_dv_c30_cog_func" min="-1" max="100" value="-1" required><br><br>
			
				<label for="soc_func">Social Functioning:</label>
				<input type="number" id="soc_func" name="hn3_dv_c30_soc_func" min="-1" max="100" value="-1" required><br><br>
			
				<label for="fatigue">Fatigue:</label>
				<input type="number" id="fatigue" name="hn3_dv_c30_fatigue" min="-1" max="100" value="-1" required><br><br>
			
				<label for="nausea">Nausea and Vomiting:</label>
				<input type="number" id="nausea" name="hn3_dv_c30_nausea" min="-1" max="100" value="-1" required><br><br>
			
				<label for="pain">Pain:</label>
				<input type="number" id="pain" name="hn3_dv_c30_pain" min="-1" max="100" value="-1" required><br><br>
			
				<label for="dyspnoea">Dyspnoea:</label>
				<input type="number" id="dyspnoea" name="hn3_dv_c30_dyspnoea" min="-1" max="100" value="-1" required><br><br>
			
				<label for="insomnia">Insomnia:</label>
				<input type="number" id="insomnia" name="hn3_dv_c30_insomnia" min="-1" max="100" value="-1" required><br><br>
			
				<label for="appetite">Loss of Appetite:</label>
				<input type="number" id="appetite" name="hn3_dv_c30_appetite" min="-1" max="100" value="-1" required><br><br>
			
				<label for="constipation">Constipation:</label>
				<input type="number" id="constipation" name="hn3_dv_c30_constipation" min="-1" max="100" value="-1" required><br><br>
			
				<label for="diarrhoea">Diarrhoea:</label>
				<input type="number" id="diarrhoea" name="hn3_dv_c30_diarrhoea" min="-1" max="100" value="-1" required><br><br>
			
				<label for="ghs">Global Health Status:</label>
				<input type="number" id="ghs" name="hn3_dv_c30_ghs" min="-1" max="100" value="-1" required><br><br>
				

		</div>
		

		<div id="hn35_details" class="details-container form-style" style="display: none;">
			<p>Please enter your EORTC QLQ-H&N35 responses (values between 0 and 100, use -1 for missing):</p>
		
			<label for="pain_hn35">Pain:</label>
			<input type="number" id="pain_hn35" name="hn3_dv_hn35_pain" min="-1" max="100" value="-1" required><br><br>
		
			<label for="speech">Speech Problems:</label>
			<input type="number" id="speech" name="hn3_dv_hn35_speech" min="-1" max="100" value="-1" required><br><br>
		
			<label for="sex">Sexuality:</label>
			<input type="number" id="sex" name="hn3_dv_hn35_sex" min="-1" max="100" value="-1" required><br><br>
		
			<label for="drymouth">Dry Mouth:</label>
			<input type="number" id="drymouth" name="hn3_dv_hn35_drymouth" min="-1" max="100" value="-1" required><br><br>
		
			<label for="ill">Feeling Ill:</label>
			<input type="number" id="ill" name="hn3_dv_hn35_ill" min="-1" max="100" value="-1" required><br><br>
		
			<label for="swallow">Swallowing:</label>
			<input type="number" id="swallow" name="hn3_dv_hn35_swallow" min="-1" max="100" value="-1" required><br><br>
		
			<label for="soceat">Social Eating:</label>
			<input type="number" id="soceat" name="hn3_dv_hn35_soceat" min="-1" max="100" value="-1" required><br><br>
		
			<label for="teeth">Teeth:</label>
			<input type="number" id="teeth" name="hn3_dv_hn35_teeth" min="-1" max="100" value="-1" required><br><br>
		
			<label for="saliva">Saliva:</label>
			<input type="number" id="saliva" name="hn3_dv_hn35_saliva" min="-1" max="100" value="-1" required><br><br>
		
			<label for="senses">Senses (taste/smell):</label>
			<input type="number" id="senses" name="hn3_dv_hn35_senses" min="-1" max="100" value="-1" required><br><br>
		
			<label for="soccon">Social Contacts:</label>
			<input type="number" id="soccon" name="hn3_dv_hn35_soccon" min="-1" max="100" value="-1" required><br><br>
		
			<label for="openmouth">Opening Mouth:</label>
			<input type="number" id="openmouth" name="hn3_dv_hn35_openmouth" min="-1" max="100" value="-1" required><br><br>
		
			<label for="cough">Cough:</label>
			<input type="number" id="cough" name="hn3_dv_hn35_cough" min="-1" max="100" value="-1" required><br><br>
		</div>
	
		<input type="submit" value="Submit">
		<button id="clear-button" type="button">Clear Results</button>

		
	</form>
</div>


	<h2> Results </h2>


	<div id="probabilities-container" style="width: 500px; height: 30px; ">
        <!-- The probabilities will appear here -->
    </div>

	<div id="predicted-container" style="width: 500px; height: 30px; ">
        <!-- The probabilities will appear here -->
    </div>

    <div id="results-container" >
        <!-- The results will appear here -->
    </div>

  



<script>
	function submitForm(event) {
	  event.preventDefault();
  
	  const form = document.getElementById('myForm');
	  const formData = new FormData(form);
  
	  const formDataJson = {};
	  for (const [key, value] of formData.entries()) {
		formDataJson[key] = parseIfNumeric(value);
	  }
  
	  fetch('http://127.0.0.1:3100/predict', {
		method: 'POST',
		credentials: 'include',
		headers: {
		  'Content-Type': 'application/json',
		  'Accept': 'application/json'
		},
		body: JSON.stringify(formDataJson),
	  })
	  .then(response => response.json())
	  .then(data => {
		console.log(data);
		displayImputation(data, formDataJson);
		plot_predicted_distribution(data.conformal_predictive_distribution);
		displayProbability(data);
		displayPredictedValue(data);
	  })
	  .catch((error) => console.error('Error:', error));
	}
  
	function parseIfNumeric(value) {
	  const number = Number(value);
	  return isNaN(number) ? value : number;
	}
  
	function displayResultsAsTable(data, userInput) {
	  const container = document.getElementById('results-container');
	  container.innerHTML = ''; // Clear previous results
  
	  // Assuming that "imputation" is an array with only one object
	  const imputationData = data.imputation && data.imputation[0];
  
	  if (!imputationData) {
		container.textContent = 'No data returned';
		return;
	  }
  
	  const table = document.createElement('table');
	  for (const key in imputationData) {
		const value = imputationData[key];
		const row = table.insertRow();
		const cellKey = row.insertCell();
		const cellValue = row.insertCell();
		cellKey.textContent = key;
  
		// Use different color if the imputed value is less than the user input
		if(typeof value === 'number' && userInput[key]< 0) {
		  cellValue.innerHTML = `<span class='imputed-value'>${value}</span>`;
		} else {
		  cellValue.textContent = value;
		}
	  }
  
	  container.appendChild(table);
	}

function displayImputation(data, userInput) {
  const form = document.getElementById('myForm');

  const imputationData = data.imputation && data.imputation[0];
  if (!imputationData) {
    console.warn('No data returned');
    return;
  }

  // Update the form inputs based on the imputation data.
  for (const key in imputationData) {


    const value = imputationData[key];
    const formInput = form.elements[key];


    if (formInput) {
      formInput.value = value;

      // If the imputedValue is automatically calculated (imputed), add the class to change the background color
      // Assuming the form contains the raw user inputs before imputation, compare them
      if (typeof value === 'number' && userInput[key]< 0) {
        formInput.classList.add('imputed-input');
      } else {
        formInput.classList.remove('imputed-input');
      }

  }
}
}



document.addEventListener('DOMContentLoaded', function() {
  const clearButton = document.getElementById('clear-button');
  const form = document.getElementById('myForm');
  const resultsContainer = document.getElementById('results-container');
  const predictedContainer = document.getElementById('predicted-container');
  const probabilitiesContainer = document.getElementById('probabilities-container');
  
  clearButton.addEventListener('click', function() {
    form.reset();
    const inputs = form.getElementsByTagName('input');
    for (const input of inputs) {
      input.classList.remove('imputed-input');
    }
	resultsContainer.innerHTML = '';
	predictedContainer.innerHTML = '';
	probabilitiesContainer.innerHTML = '';
	});
});

function displayProbability(data) {
    var container = document.getElementById('probabilities-container');

	// Format the probability as a percentage (assuming it's delivered as a decimal like 0.15 for 15%)
    const declineProbabilityPercent = (data.decline_probability * 100).toFixed(2) + '%';

    // Create a span element to highlight the probability
	const probabilitySpan = `<span class="highlight">${declineProbabilityPercent}</span>`;

	// Build the HTML string
	const htmlContent = `<p>Probability of decline: ${probabilitySpan}</p>`;

	// Assign the constructed HTML to the container's innerHTML
	container.innerHTML = htmlContent;

}

function displayPredictedValue(data){
	var container = document.getElementById('predicted-container');
	// Format the predicted value
	const predictedValue = data.predicted_value.toFixed(2);
	const ci = data.ci.map(value => value.toFixed(2));

	container.innerHTML = `<p>Predicted value [95% ci]: ${predictedValue} [ ${ci} ]</p>`;

}


function plot_predicted_distribution(data) {
    var dataToPlot = [{
        x: data,
        type: 'histogram',
    }];
    
    // Check if predicted_value is a number before adding it to layout.shapes
    const predictedValue = data.predicted_value;

    // Layout with a red vertical line at x = predictedValue
    var layout = {
        title: 'Conformal Predictive Distribution (CPD)',
        xaxis: { title: 'Value', range: [0, 100] },
        yaxis: { title: 'Count' },
        bargap: 0.05
    };
    
    // Render the plot to the div tag with id 'results-container'
    Plotly.newPlot('results-container', dataToPlot, layout);
}



 
// 	document.addEventListener('DOMContentLoaded', function() {
//     const clearButton = document.getElementById('clear-button');
//     const resultsContainer = document.getElementById('results-container');
    
//     clearButton.addEventListener('click', function() {
//       resultsContainer.innerHTML = '';
//     });
//   });
//  

</script>
  
  

</body>
</html>

